<meta charset="UTF-8">
<style type="text/css">
    *{margin:0;padding:0;}
    body{color:#333;overflow: hidden;margin: 0px;padding:5px;background: white;font-size:12px;}
    img{margin:0 4px;}
    #addItemDiv{color:#ccc;}
    .hide{display:none;}
    .show{display:block;}
    .taskItem{cursor:pointer;}
    input{width:100%;}
    label.on{width:12px; display:inline-block; height:12px; background:url(images/bg_task_on.gif) no-repeat 0px 2px;}
    label.off{width:12px; display:inline-block; height:12px; background:url(images/bg_task_off.gif) no-repeat 0px 2px;}
</style>
<div id="newItem" class="gray">添加新项</div>
<div id="addDiv" class="hide"><input type="text" id="txtTitle" /></div>
<div id="taskItemList">
    <div class="taskItem">
        <label class="on"></label><span class="taskTitle">新任务</span>
    </div>
    <div class="taskItem">
        <label class="off"></label><span class="taskTitle">已完成任务</span>
    </div>
</div>
<script>
    (function(){
        var $ = function(id){
            return document.getElementById(id);
        }

        var Tasks = {
            // 指针
            index: window.localStorage.getItem('Tasks:index');
            show: function(obj){
                obj.className = '';
                return this;
            },
            hide: function(obj){
                obj.className = 'hide';
                return this;
            },

            // 存储dom
            $addItemDiv: $('addItemDiv'),
            $addItemInput: $('addItemInput'),
            $txtTaskTitle: $('txtTaskTitle'),
            $taskItemList: $('taskItemList'),

            addEvent: function () {
                if (document.addEventListener) {
                    return function (el, type, fn) {
                        if (el.length) {
                            for (var i = 0; i & lt; el.length; i++) {
                                addEvent(el[i], type, fn);
                            }
                        } else {
                            el.addEventListener(type, fn, false);
                        }
                    };
                } else {
                    return function (el, type, fn) {
                        if (el.length) {
                            for (var i = 0; i & lt; el.length; i++) {
                                addEvent(el[i], type, fn);
                            }
                        } else {
                            el.attachEvent(‘on‘ + type, function () {
                                return fn.call(el, window.event);
                            });
                        }
                    };
                }
            },

            // 初始化
            init: function(){
                if(!Task.index){
                    window.localStorage.setItem('Tasks:index',Tasks.index = 0);
                }
                /*注册事件*/
                //打开添加文本框
                Tasks.addEvent(Tasks.$addItemDiv,'click',function(){
                    Tasks.show(Tasks.$addItemInput).hide(Tasks.$addItemDiv);
                    Tasks.$txtTaskTitle.focus();
                });

                // 回车添加
                Tasks.addEvent(Tasks.$txtTaskTitle,'keyup',function(ev){
                    var ev = ev || window.event;
                    if(ev.keyCode == 13){
                        // TODO:写入本地数据
                        Tasks.AppendHtml(Tasks.$txtTaskTitle.value);
                        Tasks.$txtTaskTitle.value='';
                        Tasks.hide($addItemInput).show(Tasks.$addItemDiv);
                    }
                    ev.preventDefault();
                });

                // 取消
                Tasks.addEvent(Tasks.$txtTaskTitle,'blur',function(){
                    Tasks.$txtTaskTitle.value='';
                    Tasks.hide(Tasks.$addItemInput).show(Tasks.$addItemDiv);
                });

                // TODO:初始化数据，加载本地数据，生成html
                if(window.localStorage.length - 1){
                    var task_list = [];
                    var key;
                    for (var i = window.localStorage.length - 1; i >= 0; i--) {
                        key = window.localStorage.key[i];
                        if(/task:\d+/.test(key)){
                            task_list.push(JSON.parse(window.localStorage.getItem(key)));
                        }
                    }

                    for (var i = task_list.length - 1; i >= 0; i--) {
                        Tasks.AppendHtml(task_list[i]);
                    };
                }
            },

            // add
            Add: function(task){
                // 更新指针
                window.localStorage.setItem('Tasks:index',++Tasks.index);
                task.id = Tasks.index;
                window.localStorage.setItem('task:' + Tasks.index,JSON.stringify(task));
            },

            // 删除
            Del:function (task) {
                window.localStorage.removeItem('task:'+ task.id);
            },

            // 修改
            Edit:function(task){
                window.localStorage.removeItem('task:' + task.id);
            },

            AppendHtml:function(title){
                var oDiv = document.createElement('div');
                oDiv.className = 'taskItem';
                var oLabel = document.createElement('label');
                oLabel.className = 'on';
                var oSpan = document.createElement('span');
                oSpan.className = 'taskTitle';
                var oText = document.createTextNode(title);
                oSpan.appendChild(oText);
                oDiv.appendChild(oLabel);
                oDiv.appendChild(oSpan);
                Tasks.addEvent(oDiv,'click',function(){
                    // TODO
                });
                Tasks.$taskItemList.appendChild(oDiv);  
            },
            RemoveHtml:function(){
                // TODO
            }
        }

        Tasks.init();
    })();
</script>
